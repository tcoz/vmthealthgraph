<!DOCTYPE html>

<html>

<head>
    <title>VMTurbo Entity Graph</title>

    <link rel="stylesheet" href="css/main.css">
    <link type="text/css" rel="Stylesheet" href="js/libs/blackbirdjs/blackbird.css" />
    <script type="text/javascript" src="js/libs/blackbirdjs/blackbird.js"></script>
    <script src="js/libs/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/singletons_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/commands_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/utils_jsbase.js"></script>
</head>

<body>

<script type="text/javascript">

    // tcoz Framework namespace, only used by the utils and parser scripts in simple version.
    // don't delete or change this or the tcoz and parser scripts won't work.
    tcoz = { },
    that = this;

    // Alter these for your needs, watch the formatting, like trailing slashes and such.
    var _applianceAddress = 'http://localhost:8400/vmturbo/api/';
    var _virtualMachinesUrl = _applianceAddress + 'markets/Market/entities?classname=VirtualMachine&property=priceIndex';

    // When the document loads, this will run.
    jQuery ( document ).ready ( function ( ) {
        startApp ( );
    } );

    var _ajaxCallCommand = ( tcoz.ajaxCallCommand = baseCommand ( ) );
    function startApp ( ) {

        _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                { 'destination' : _virtualMachinesUrl, 'callback' : onStartupCallsReturn }
        );
    }

    var _vmInfo = [ ];
    function onStartupCallsReturn ( dataObj ) {

        var i,
            xmlDoc,
            virtualMachines, vmElement, vmObj, vmDisplayName, vmPriceIndex, vmUUID,
            hostCallUrl;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        virtualMachines = jQuery ( xmlDoc ).find ( 'ServiceEntity' );

        if ( virtualMachines.length > 0 ) {

            for ( i = 0; i < virtualMachines.length; i += 1 ) {
                vmElement = virtualMachines [ i ];
                vmDisplayName = jQuery ( vmElement ).attr ( 'displayName' );
                vmPriceIndex = jQuery ( vmElement ).attr ( 'priceIndex' );
                vmUUID = jQuery ( vmElement ).attr ( 'uuid' );

                _vmInfo.push ( { 'vm' : vmDisplayName, 'priceindex' : vmPriceIndex, 'uuid' : vmUUID } );
            }
        }

        for ( i = 0; i < _vmInfo.length; i += 1 ) {
            vmObj = _vmInfo [ i ];
            hostCallUrl = _applianceAddress + 'markets/Market/virtualmachines/' + vmObj.uuid + '/hosts?property=priceIndex';

            _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                    { 'destination' : hostCallUrl, 'callback' : onHostsCallsReturn, 'data' : vmObj }
            );
        }
    }

    var _vmAndHostInfo = [ ];
    function onHostsCallsReturn ( dataObj ) {

        var i,
            xmlDoc,
            vmObj, vmAndHostObj, vmElement,
            hostElement, hostDisplayName, hostPriceIndex,
            dsCallUrl;

        log.info ( dataObj.ajaxReturn );

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        hostElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        hostDisplayName = jQuery ( hostElement ).attr ( 'displayName' );
        hostPriceIndex = jQuery ( hostElement ).attr ( 'priceIndex' );

        vmObj = dataObj.data;
        vmAndHostObj = { 'vm' : vmObj.vm, 'priceindex' : vmObj.priceindex, 'uuid' : vmObj.uuid, 'host' : hostDisplayName, 'hostpriceindex' : hostPriceIndex };

        _vmAndHostInfo.push ( vmAndHostObj );

        if ( _vmAndHostInfo.length === _vmInfo.length ) {

            for ( i = 0; i < _vmAndHostInfo.length; i += 1 ) {
                vmAndHostObj = _vmAndHostInfo [ i ];
                dsCallUrl = _applianceAddress + 'markets/Market/virtualmachines/' + vmAndHostObj.uuid + '/datastores?property=priceIndex';

                _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                        { 'destination' : dsCallUrl, 'callback' : onDataStoreCallsReturn, 'data' : vmAndHostObj }
                );
            }
        }
    }

    var _vmAndHostAndDatastoreInfo = [ ];
    function onDataStoreCallsReturn ( dataObj ) {

        var i,
            xmlDoc,
            vmAndHostObj,
            dsElement, dsDisplayName, dsPriceIndex;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        dsElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        dsDisplayName = jQuery ( dsElement ).attr ( 'displayName' );
        dsPriceIndex = jQuery ( dsElement ).attr ( 'priceIndex' );

        vmAndHostObj = dataObj.data;
        vmAndHostObj.ds = dsDisplayName;
        vmAndHostObj.dspriceindex = dsPriceIndex;

        _vmAndHostAndDatastoreInfo.push ( vmAndHostObj );

        if ( _vmAndHostAndDatastoreInfo.length === _vmInfo.length ) {
            var str = JSON.stringify ( _vmAndHostInfo );
            // jQuery ( '#chartContainer' ).text ( str );
        }

        turnInfoCSV ( );
    }

    function turnInfoCSV ( )
    {
        var i, str, obj;

        str = 'vm,uuid,host,ds,priceindex,hostpriceindex,dspriceindex\\n';

        for ( i = 0; i < _vmAndHostAndDatastoreInfo.length; i += 1 ) {
            obj = _vmAndHostAndDatastoreInfo [ i ];
            str = str + obj.vm + ',' + obj.uuid + ',' + obj.host + ',' + obj.ds + ',' + obj.priceindex + ',' + obj.hostpriceindex + ',' + obj.dspriceindex + '\\n';
        }

        jQuery ( '#chartContainer').html ( str );
    }


</script>

<div id="chartContainer"></div>

</body>

</html>
