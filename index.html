<!DOCTYPE html>

<html>

<head>
    <title>VMTurbo Entity Graph</title>

    <link rel="stylesheet" href="css/main.css">
    <link type="text/css" rel="Stylesheet" href="js/libs/blackbirdjs/blackbird.css" />
    <script type="text/javascript" src="js/libs/blackbirdjs/blackbird.js"></script>
    <script src="js/libs/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/singletons_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/commands_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/utils_jsbase.js"></script>
</head>

<body>

<script type="text/javascript">

   // tcoz Framework namespace.
   // Don't delete or change this.
   tcoz = { };

   // lap is short for "localApp"
   // Prevents collisions when integrating into larger structure.
   var lap = { };

   jQuery ( document ).ready ( function ( ) {

       lap = {
                applianceAddress : 'http://localhost:8400/vmturbo/api/',
                originPoint : { },
                chart_layer1 : null,
                chart_layer1_context : null,
                chart_layer2 : null,
                chart_layer2_context : null,
                powVals : [ ],
                axisLength : 500,
                vmInfo : [ ],
                vmAndHostInfo : [ ],
                vmAndHostAndDatastoreInfo : [ ]
        };

       setInterval ( startApp, 30000 );
       drawBaseChart ( );
       startApp ( );

    } );

    function drawBaseChart ( )
    {
        var i, xPoint, yPoint,
            chart_layer1 = lap.chart_layer1 = jQuery ( '#chart_layer1' ).get ( 0 ),
            chart_layer1_context = lap.chart_layer1_context = chart_layer1.getContext ( '2d' ),
            chart_layer2 = lap.chart_layer2 = jQuery ( '#chart_layer2' ).get ( 0 ),
            chart_layer2_context = lap.chart_layer2_context = chart_layer2.getContext ( '2d' ),
            originPoint = lap.originPoint = { 'x' : 100, 'y' : chart_layer1.height - 100 };

        lap.powVals.push ( 0 );

        for ( i = 0; i < 10; i++ ) {
            lap.powVals.push ( Math.floor ( Math.pow ( 10, ( i * 0.477893 ) ) ) );
        }

        chart_layer1_context.strokeStyle = '#000000';

        chart_layer1_context.beginPath ( );
        chart_layer1_context.moveTo ( originPoint.x, originPoint.y  );
        chart_layer1_context.lineTo ( originPoint.x + lap.axisLength, originPoint.y );
        chart_layer1_context.stroke ( );

        chart_layer1_context.beginPath ( );
        chart_layer1_context.moveTo ( originPoint.x, originPoint.y  );
        chart_layer1_context.lineTo ( originPoint.x, originPoint.y - lap.axisLength );
        chart_layer1_context.stroke ( );

        chart_layer1_context.font = 'bold 14px sans-serif';
        chart_layer1_context.fillStyle = '#000000';
        chart_layer1_context.fillText ( 'DS UI', 10, 300 );
        chart_layer1_context.fillText ( 'HOST UI', 295, 570 );

        chart_layer1_context.font = '10px sans-serif';

        for ( i = 0; i < lap.powVals.length; i++ ) {

            xPoint = originPoint.x + ( i * ( lap.axisLength / 10 ) );
            yPoint = originPoint.y - ( i * ( lap.axisLength / 10 ) );

            chart_layer1_context.fillText ( lap.powVals [ i ].toString ( ), xPoint, originPoint.y + 15 );
            chart_layer1_context.fillText ( lap.powVals [ i ].toString ( ), originPoint.x - 40, yPoint );

            chart_layer1_context.strokeStyle = '#666666';
            chart_layer1_context.beginPath ( );
            chart_layer1_context.moveTo ( xPoint, originPoint.y );
            chart_layer1_context.lineTo ( xPoint, originPoint.y - lap.axisLength );
            chart_layer1_context.stroke ( );

            chart_layer1_context.beginPath ( );
            chart_layer1_context.moveTo ( originPoint.x, yPoint );
            chart_layer1_context.lineTo ( originPoint.x + lap.axisLength, yPoint );
            chart_layer1_context.stroke ( );
        }
    }

    function startApp ( ) {

        lap.vmInfo = [ ];
        lap.vmAndHostInfo = [ ];
        lap.vmAndHostAndDatastoreInfo = [ ];

        clearContext ( lap.chart_layer2_context );

        var virtualMachinesUrl = lap.applianceAddress + 'markets/Market/entities?classname=VirtualMachine&property=priceIndex',
            ajaxCallCommand = ( tcoz.ajaxCallCommand = baseCommand ( ) );

        ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                { 'destination' : virtualMachinesUrl, 'callback' : onStartupCallsReturn }
        );

    }

    function onStartupCallsReturn ( dataObj ) {

        var i, ajaxCallCommand,
            xmlDoc,
            virtualMachines, vmElement, vmObj, vmDisplayName, vmPriceIndex, vmUUID,
            hostCallUrl;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        virtualMachines = jQuery ( xmlDoc ).find ( 'ServiceEntity' );

        if ( virtualMachines.length > 0 ) {

            for ( i = 0; i < virtualMachines.length; i += 1 ) {
                vmElement = virtualMachines [ i ];
                vmDisplayName = jQuery ( vmElement ).attr ( 'displayName' );
                vmPriceIndex = jQuery ( vmElement ).attr ( 'priceIndex' );
                vmUUID = jQuery ( vmElement ).attr ( 'uuid' );

                lap.vmInfo.push ( { 'vm' : vmDisplayName, 'priceindex' : vmPriceIndex, 'uuid' : vmUUID } );
            }
        }

        for ( i = 0; i < lap.vmInfo.length; i += 1 ) {
            vmObj = lap.vmInfo [ i ];
            hostCallUrl = lap.applianceAddress + 'markets/Market/virtualmachines/' + vmObj.uuid + '/hosts?property=priceIndex';

            ajaxCallCommand = ( tcoz.ajaxCallCommand = baseCommand ( ) );
            ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                    { 'destination' : hostCallUrl, 'callback' : onHostsCallsReturn, 'data' : vmObj }
            );
        }
    }

    function onHostsCallsReturn ( dataObj ) {

        var i, ajaxCallCommand,
            xmlDoc,
            vmObj, vmAndHostObj,
            hostElement, hostDisplayName, hostPriceIndex,
            dsCallUrl;

        log.info ( dataObj.ajaxReturn );

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        hostElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        hostDisplayName = jQuery ( hostElement ).attr ( 'displayName' );
        hostPriceIndex = jQuery ( hostElement ).attr ( 'priceIndex' );

        vmObj = dataObj.data;
        vmAndHostObj = { 'vm' : vmObj.vm, 'priceindex' : vmObj.priceindex, 'uuid' : vmObj.uuid, 'host' : hostDisplayName, 'hostpriceindex' : hostPriceIndex };

        lap.vmAndHostInfo.push ( vmAndHostObj );

        if ( lap.vmAndHostInfo.length === lap.vmInfo.length ) {

            for ( i = 0; i < lap.vmAndHostInfo.length; i += 1 ) {
                vmAndHostObj = lap.vmAndHostInfo [ i ];
                dsCallUrl = lap.applianceAddress + 'markets/Market/virtualmachines/' + vmAndHostObj.uuid + '/datastores?property=priceIndex';

                ajaxCallCommand = ( tcoz.ajaxCallCommand = baseCommand ( ) );
                ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                        { 'destination' : dsCallUrl, 'callback' : onDataStoreCallsReturn, 'data' : vmAndHostObj }
                );
            }
        }
    }

    function onDataStoreCallsReturn ( dataObj ) {

        var xmlDoc,
            vmAndHostObj,
            dsElement, dsDisplayName, dsPriceIndex;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        dsElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        dsDisplayName = jQuery ( dsElement ).attr ( 'displayName' );
        dsPriceIndex = jQuery ( dsElement ).attr ( 'priceIndex' );

        vmAndHostObj = dataObj.data;
        vmAndHostObj.ds = dsDisplayName;
        vmAndHostObj.dspriceindex = dsPriceIndex;

        // this is your bank, essentially.
        lap.vmAndHostAndDatastoreInfo.push ( vmAndHostObj );

        plotVM ( [ vmAndHostObj ] );

        if ( lap.vmAndHostAndDatastoreInfo.length === lap.vmInfo.length ) {
            // var str = JSON.stringify ( _vmAndHostInfo );
            // jQuery ( '#chartContainer' ).text ( str );
            turnIntoCSV ( lap.vmAndHostAndDatastoreInfo );
        }
    }

    function plotVM ( chartData ) {

        for ( i = 0; i < chartData.length; i++ ) {

            var vmPI = chartData [ i ].priceindex,
                hostPI = chartData [ i ].hostpriceindex,
                dsPI = chartData [ i ].dspriceindex,
                xAxisPoints, yAxisPoints, xPoint, yPoint,
                radius = 1;

            for ( j = 0; j < lap.powVals.length; j++ ) {

                if ( hostPI >= lap.powVals [ j ] && hostPI < lap.powVals [ j + 1 ] ) {
                    xAxisPoints = [ j, lap.powVals [ j ], lap.powVals [ j + 1 ] ];
                    j = lap.powVals.length;
                }
            }

            for ( j = 0; j < lap.powVals.length; j++ ) {

                if ( dsPI >= lap.powVals [ j ] && dsPI < lap.powVals [ j + 1 ] ) {
                    yAxisPoints = [ j, lap.powVals [ j ], lap.powVals [ j + 1 ] ];
                    j = lap.powVals.length;
                }
            }

            for ( j = 0; j < lap.powVals.length; j++ ) {

                if ( vmPI >= lap.powVals [ j ] && vmPI < lap.powVals [ j + 1 ] ) {
                    radius = j * 2;
                    j = lap.powVals.length;
                }
            }

            xPoint = computePoint ( xAxisPoints, hostPI );
            yPoint = computePoint ( yAxisPoints, dsPI );

            lap.chart_layer2_context.fillStyle = '#0000FF';
            lap.chart_layer2_context.beginPath();
            lap.chart_layer2_context.arc ( lap.originPoint.x + xPoint, lap.originPoint.y - yPoint, radius, 0, 2 * Math.PI, false );
            lap.chart_layer2_context.fill();
        }
    }

    function computePoint ( arr, point ) {

        var retVal = 0;

        try {
            var totalUnit = lap.axisLength / 10,
                powValIndex = arr [ 0 ],
                start = arr [ 1 ],
                end = arr [ 2 ],
                diff = end - start,
                unit = totalUnit / diff,
                plotPoint = diff / point;

           retVal = ( ( powValIndex )  * 50 ) + ( unit * ( plotPoint * powValIndex ) );
        }
        catch ( e ) { console.log ( ); retVal = 0; }

        return retVal;
    }

    function turnIntoCSV ( chartData )
    {
        var i, str, obj;

        str = '<div>vm,uuid,host,ds,priceindex,hostpriceindex,dspriceindex</div>';

        for ( i = 0; i < chartData.length; i += 1 ) {
            obj = chartData [ i ];
            str = str + '<div>';
            str = str + obj.vm + ',' + obj.uuid + ',' + obj.host + ',' + obj.ds + ',' + obj.priceindex + ',' + obj.hostpriceindex + ',' + obj.dspriceindex;
            str = str + '</div>';
        }

        jQuery ( '#rawData').html ( str );
    }

   function clearContext ( context )
   {
       context.setTransform ( 1, 0, 0, 1, 0, 0 );
       context.clearRect ( 0, 0, lap.chart_layer1.width, lap.chart_layer1.height );
       context.restore ( );
   }


</script>

<canvas id="chart_layer1" width="700" height="625" style="z-index: 0;"></canvas>
<canvas id="chart_layer2" width="700" height="625" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>

<div id="rawData" class="rawDataStyle"></div>

</body>

</html>