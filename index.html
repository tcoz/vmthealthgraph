<!DOCTYPE html>

<html>

<head>
    <title>VMTurbo Entity Graph</title>

    <link rel="stylesheet" href="css/main.css">
    <link type="text/css" rel="Stylesheet" href="js/libs/blackbirdjs/blackbird.css" />
    <script type="text/javascript" src="js/libs/blackbirdjs/blackbird.js"></script>
    <script src="js/libs/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/singletons_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/commands_jsbase.js"></script>
    <script type="text/javascript" src="js/libs/tcoz/jsbase/utils_jsbase.js"></script>
</head>

<body>

<script type="text/javascript">

    // tcoz Framework namespace, only used by the utils and parser scripts in simple version.
    // don't delete or change this or the tcoz and parser scripts won't work.
    tcoz = { },
    that = this;

    // Alter these for your needs, watch the formatting, like trailing slashes and such.
    var _applianceAddress = 'http://localhost:8400/vmturbo/api/';
    var _virtualMachinesUrl = _applianceAddress + 'markets/Market/entities?classname=VirtualMachine&property=priceIndex';



    // When the document loads, this will run.
    jQuery ( document ).ready ( function ( ) {
        setTimeout ( refreshWindow, 30000 );
        drawBaseChart ( );
        startApp ( );
    } );

    function refreshWindow ( ) {
        window.location.reload ( true );
    }

    var originPoint,
        chart_layer1, chart_layer1_context,
        chart_layer2, chart_layer2_context,
        powVals = [ ],
        axisLength = 500;

    function drawBaseChart ( )
    {
        var i, j, xPoint, yPoint;

        chart_layer1 = jQuery ( '#chart_layer1' ).get ( 0 );
        chart_layer1_context = chart_layer1.getContext ( '2d');
        chart_layer2 = jQuery ( '#chart_layer2' ).get ( 0 );
        chart_layer2_context = chart_layer2.getContext ( '2d');

        originPoint = { 'x' : 100, 'y' : chart_layer1.height - 100 };

        powVals.push ( 0 );

        for ( i = 0; i < 10; i++ ) {
            powVals.push ( Math.floor ( Math.pow ( 10, ( i * 0.477893 ) ) ) );
        }

        chart_layer1_context.strokeStyle = '#000000';

        chart_layer1_context.beginPath ( );
        chart_layer1_context.moveTo ( originPoint.x, originPoint.y  );
        chart_layer1_context.lineTo ( originPoint.x + axisLength, originPoint.y );
        chart_layer1_context.stroke ( );

        chart_layer1_context.beginPath ( );
        chart_layer1_context.moveTo ( originPoint.x, originPoint.y  );
        chart_layer1_context.lineTo ( originPoint.x, originPoint.y - axisLength );
        chart_layer1_context.stroke ( );

        chart_layer1_context.font = 'bold 14px sans-serif';
        chart_layer1_context.fillStyle = '#000000';
        chart_layer1_context.fillText ( 'DS UI', 10, 300 );
        chart_layer1_context.fillText ( 'HOST UI', 295, 570 );

        chart_layer1_context.font = '10px sans-serif';

        for ( i = 0; i < powVals.length; i++ ) {

            xPoint = originPoint.x + ( i * ( axisLength / 10 ) );
            yPoint = originPoint.y - ( i * ( axisLength / 10 ) );

            chart_layer1_context.fillText ( powVals [ i ].toString ( ), xPoint, originPoint.y + 15 );
            chart_layer1_context.fillText ( powVals [ i ].toString ( ), originPoint.x - 40, yPoint );

            chart_layer1_context.strokeStyle = '#666666';
            chart_layer1_context.beginPath ( );
            chart_layer1_context.moveTo ( xPoint, originPoint.y );
            chart_layer1_context.lineTo ( xPoint, originPoint.y - axisLength );
            chart_layer1_context.stroke ( );

            chart_layer1_context.beginPath ( );
            chart_layer1_context.moveTo ( originPoint.x, yPoint );
            chart_layer1_context.lineTo ( originPoint.x + axisLength, yPoint );
            chart_layer1_context.stroke ( );
        }
    }

    var _ajaxCallCommand = ( tcoz.ajaxCallCommand = baseCommand ( ) );
    function startApp ( ) {
        _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                { 'destination' : _virtualMachinesUrl, 'callback' : onStartupCallsReturn }
        );
    }

    var _vmInfo = [ ];
    function onStartupCallsReturn ( dataObj ) {

        console.log ( 'STARTUP CALLS RETURNED' );

        var i,
            xmlDoc,
            virtualMachines, vmElement, vmObj, vmDisplayName, vmPriceIndex, vmUUID,
            hostCallUrl;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        virtualMachines = jQuery ( xmlDoc ).find ( 'ServiceEntity' );

        if ( virtualMachines.length > 0 ) {

            for ( i = 0; i < virtualMachines.length; i += 1 ) {
                vmElement = virtualMachines [ i ];
                vmDisplayName = jQuery ( vmElement ).attr ( 'displayName' );
                vmPriceIndex = jQuery ( vmElement ).attr ( 'priceIndex' );
                vmUUID = jQuery ( vmElement ).attr ( 'uuid' );

                _vmInfo.push ( { 'vm' : vmDisplayName, 'priceindex' : vmPriceIndex, 'uuid' : vmUUID } );
            }
        }

        for ( i = 0; i < _vmInfo.length; i += 1 ) {
            vmObj = _vmInfo [ i ];
            hostCallUrl = _applianceAddress + 'markets/Market/virtualmachines/' + vmObj.uuid + '/hosts?property=priceIndex';

            _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                    { 'destination' : hostCallUrl, 'callback' : onHostsCallsReturn, 'data' : vmObj }
            );
        }
    }

    var _vmAndHostInfo = [ ];
    function onHostsCallsReturn ( dataObj ) {

        console.log ( 'HOSTS CALL RETURNED' );

        var i,
            xmlDoc,
            vmObj, vmAndHostObj, vmElement,
            hostElement, hostDisplayName, hostPriceIndex,
            dsCallUrl;

        log.info ( dataObj.ajaxReturn );

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        hostElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        hostDisplayName = jQuery ( hostElement ).attr ( 'displayName' );
        hostPriceIndex = jQuery ( hostElement ).attr ( 'priceIndex' );

        vmObj = dataObj.data;
        vmAndHostObj = { 'vm' : vmObj.vm, 'priceindex' : vmObj.priceindex, 'uuid' : vmObj.uuid, 'host' : hostDisplayName, 'hostpriceindex' : hostPriceIndex };

        _vmAndHostInfo.push ( vmAndHostObj );

        if ( _vmAndHostInfo.length === _vmInfo.length ) {

            for ( i = 0; i < _vmAndHostInfo.length; i += 1 ) {
                vmAndHostObj = _vmAndHostInfo [ i ];
                dsCallUrl = _applianceAddress + 'markets/Market/virtualmachines/' + vmAndHostObj.uuid + '/datastores?property=priceIndex';

                _ajaxCallCommand.dispatchCommandNotification ( 'AJAX_CALL',
                        { 'destination' : dsCallUrl, 'callback' : onDataStoreCallsReturn, 'data' : vmAndHostObj }
                );
            }
        }
    }

    var _vmAndHostAndDatastoreInfo = [ ];
    function onDataStoreCallsReturn ( dataObj ) {

        console.log ( 'DATA CALLS RETURNED' );

        var i,
            xmlDoc,
            vmAndHostObj,
            dsElement, dsDisplayName, dsPriceIndex;

        try { xmlDoc = jQuery.parseXML ( dataObj.ajaxReturn ); }
        catch ( err ) { xmlDoc = jQuery.parseXML ( '<root />' ); }

        dsElement = jQuery ( xmlDoc ).find ( 'ServiceEntity' );
        dsDisplayName = jQuery ( dsElement ).attr ( 'displayName' );
        dsPriceIndex = jQuery ( dsElement ).attr ( 'priceIndex' );

        vmAndHostObj = dataObj.data;
        vmAndHostObj.ds = dsDisplayName;
        vmAndHostObj.dspriceindex = dsPriceIndex;

        plotVM ( [ vmAndHostObj ] );

        _vmAndHostAndDatastoreInfo.push ( vmAndHostObj );

        if ( _vmAndHostAndDatastoreInfo.length === _vmInfo.length ) {
            // var str = JSON.stringify ( _vmAndHostInfo );
            // jQuery ( '#chartContainer' ).text ( str );
            turnIntoCSV ( _vmAndHostAndDatastoreInfo );
        }
    }

    function plotVM ( chartData ) {

        for ( i = 0; i < chartData.length; i++ ) {

            var vmPI = chartData [ i ].priceindex;
            var hostPI = chartData [ i ].hostpriceindex;
            var dsPI = chartData [ i ].dspriceindex;
            var xAxisPoints;
            var yAxisPoints;

            for ( j = 0; j < powVals.length; j++ ) {

                if ( hostPI >= powVals [ j ] && hostPI < powVals [ j + 1 ] ) {
                    xAxisPoints = [ j, powVals [ j ], powVals [ j + 1 ] ];
                    j = powVals.length;
                }
            }

            for ( j = 0; j < powVals.length; j++ ) {

                if ( dsPI >= powVals [ j ] && dsPI < powVals [ j + 1 ] ) {
                    yAxisPoints = [ j, powVals [ j ], powVals [ j + 1 ] ];
                    j = powVals.length;
                }
            }

            var radius = 1;
            for ( j = 0; j < powVals.length; j++ ) {

                if ( vmPI >= powVals [ j ] && vmPI < powVals [ j + 1 ] ) {
                    radius = j * 2;
                    j = powVals.length;
                }
            }

            var xPoint = computePoint ( xAxisPoints, hostPI, axisLength );
            var yPoint = computePoint ( yAxisPoints, dsPI, axisLength );

            chart_layer2_context.fillStyle = '#0000FF';
            chart_layer2_context.beginPath();
            chart_layer2_context.arc ( originPoint.x + xPoint, originPoint.y - yPoint, radius, 0, 2 * Math.PI, false );
            chart_layer2_context.fill();
        }

        function computePoint ( arr, point, axisLength ) {

            try {
                var totalUnit = axisLength / 10;
                var powValIndex = arr [ 0 ];
                var start = arr [ 1 ];
                var end = arr [ 2 ];
                var totalSpace = axisLength / 10;

                var diff = end - start;
                var unit = totalUnit / diff;
                var plotPoint = diff / point;

                return ( ( powValIndex )  * 50 ) + ( unit * ( plotPoint * powValIndex ) );
            }
            catch ( e ) { console.log ( ); }
        }
    }

    function turnIntoCSV ( chartData )
    {
        var i, str, obj;

        str = '<div>vm,uuid,host,ds,priceindex,hostpriceindex,dspriceindex</div>';

        for ( i = 0; i < chartData.length; i += 1 ) {
            obj = chartData [ i ];
            str = str + '<div>';
            str = str + obj.vm + ',' + obj.uuid + ',' + obj.host + ',' + obj.ds + ',' + obj.priceindex + ',' + obj.hostpriceindex + ',' + obj.dspriceindex;
            str = str + '</div>';
        }

        jQuery ( '#rawData').html ( str );
    }


</script>

<canvas id="chart_layer1" width="700" height="625" style="z-index: 0;"></canvas>
<canvas id="chart_layer2" width="700" height="625" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>

<div id="rawData" style="font-family: Arial; font-size: 12px; position: relative; left: 0; top: 0;"></div>

</body>

</html>
